# テスト最適化ガイド（任意）

## 概要

**目的**: AglaError/ErrorSeverity テストスイートの品質向上と実行効率の最適化（軽量化は必須ではなく任意）\
**現状**: 94テスト（正常/異常/エッジの網羅追加に伴う一時的な増加を許容） → **最終目安**: 50-65テスト（品質優先・増減可）\
**方針**: 冗長・自明なテストの見直し、価値あるテストの強化（削除・統合は任意）

## 見直し候補（任意）

### 🗑️（任意）候補1: 自明な定数値テスト（最大4テスト）

対象例: `ErrorSeverity.spec.ts` の enum 値固定確認。

見直し理由（任意）:

- TypeScript enum 定数は変更されにくく、型で保証される
- 実行時テストの価値が相対的に低い

### 🗑️（任意）候補2: instanceof チェックテスト（6-8テスト）

対象例: `AglaError.spec.ts`, `AglaError.inheritance.spec.ts` の継承確認。

見直し理由（任意）:

- 継承関係は言語仕様により保証される
- ビジネスロジックの検証価値が低い

### 🗑️（任意・要注意）候補3: デフォルト値 undefined/null テスト（最大9テスト）

対象例: `AglaError.spec.ts` のオプション未指定時の `undefined` 確認。

見直し理由（任意）:

- オプションのデフォルトは実装/型から自明なケースが多い
- BDD再構成で期待が集約される

注意: 仕様の明確化に寄与している場合は保持を推奨。

### 🔄（推奨）候補4: 重複バリデーションテストの統合（10-15テスト）

対象例: `ErrorSeverity` の有効/無効値チェックの個別列挙をパラメータ化で統合。

統合例（任意）:

```ts
describe('When validating ErrorSeverity values', () => {
  it('Then validates all valid severity values', () => {
    const validValues = ['fatal', 'error', 'warning', 'info'];
    validValues.forEach((v) => expect(isValidErrorSeverity(v)).toBe(true));
  });
});
```

## 保持・強化すべきテスト

1. ビジネスロジック検証（チェーン、JSON、コンテキスト結合）
2. エラーハンドリング（抽象層の挙動変更は行わない前提）
3. 統合シナリオ（実使用に近いワークフロー）
4. セキュリティ/パフォーマンス（循環参照、巨大データ、特殊文字）

## 新テスト構成（最適化の目安）

- フェーズ2A: ユニット（35-40目安・増減可）
- フェーズ2B: ファンクショナル（8-10目安・増減可）
- フェーズ2C: インテグレーション（6-8目安・増減可）
- フェーズ2D: E2E（5-7目安・増減可）

## 実装方針（優先順位）

1. 3階層 BDD 再構成を完了（件数は問わない）
2. 重複統合や冗長削除は任意で実施（品質/明確性を優先）
3. 正常/異常/エッジの追加による増加は許容（品質優先）

### テスト見直しプロセス（任意）

1. 段階的に適用して都度テストを実行
2. 削除/統合後のカバレッジ確認とギャップ把握
3. 品質劣化があればロールバックまたは補完

### 新テスト追加プロセス

1. カバレッジギャップの特定
2. 不足する E2E/機能テストの補完
3. セキュリティ/パフォーマンスの強化

### ランタイムガード/フォールバック方針（重要）

- 抽象層（本パッケージ）ではランタイムガード（即時 throw）やフォールバック（Unknown 丸め込み）は実装しない。
- これらは実装クラス/ファクトリ層の責務。必要に応じてポリシーを選択し、検証は機能/統合テストで行う。

## 品質保証指標（ガイドライン）

### 最適化目安

- テスト数: 50-65 を目安（増減可・品質優先）
- 実行時間: 実用性能の確保（目安として約30%短縮を狙う）
- 保守コスト: 重複排除・構造整理で削減

### 品質維持目標

- コードカバレッジ: 90%以上を維持
- 機能カバレッジ: 向上（重要機能の強化）
- テスト品質: 意味のあるテストを優先

## 成果物（任意）

1. 最適化されたテストスイート（件数は目安）
2. 統合テストヘルパー（共通ロジックの関数化）
3. E2Eテストセット（必要に応じて追加）
4. 更新された TODO.md（任意項目は任意として明記）

---

**作成日**: 2025-08-31\
**更新日**: 2025-08-31\
**ステータス**: 参考ガイド（任意適用）
