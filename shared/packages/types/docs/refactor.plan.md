# テスト構造リファクタリング計画書

## 概要

**目的**: AglaError/ErrorSeverity テストスイートを Given/When/Then BDD構造に再構成\
**対象**: 94テストケース（ユニット82 + ファンクショナル4 + インテグレーション8）を起点（増加許容）\
**目標**: 3階層describe + 正常系/異常系/エッジケースの網羅による保守性・明確性向上（必要な追加テストは許容）

## 構造変更の背景

### 現在の問題点

**現在の構造（非効率）:**

```
Given [対象オブジェクト/状態]
├── When [正常な操作/条件]     ← 正常系が分離
│   └── Then [期待される正常結果]
├── When [異常な操作/条件]     ← 異常系が分離
│   └── Then [期待されるエラー処理]  
└── When [境界値/特殊条件]     ← エッジケースが分離
    └── Then [期待されるエッジケース処理]
```

**問題点:**

- テストロジックが重複（各Whenで同じ操作コードを繰り返し）
- 共通のテスト準備コードが散在
- 正常系/異常系の違いが操作レベルで分離され、パラメータ違いが不明確

### 新構造（改善）

**新構造（効率的）:**

```
Given [対象オブジェクト/状態]
└── When [共通のテストロジック/操作]
    ├── Then [正常系：期待される正常結果]
    ├── Then [異常系：期待されるエラー処理]
    └── Then [エッジケース：期待される境界値処理]
```

**改善効果:**

- 共通テストロジックの統合（DRY原則）
- パラメータ違いによる結果の違いが明確
- テストの保守性とリーダビリティ向上
- 正常系/異常系/エッジケースの網羅強化（必要に応じてテスト数の増加を許容）

## 具体的な構造設計

### 基本パターン

#### パターン1: コンストラクタテスト

```typescript
describe('Given AglaError constructor', () => {
  describe('When エラーオブジェクトを作成する', () => {
    it('Then 正常系：有効パラメータで正常作成される', () => {
      // 有効パラメータでの作成テスト
    });

    it('Then 異常系：必須パラメータ未指定でThrowErrorが発生する', () => {
      // 無効パラメータでのエラーテスト
    });

    it('Then エッジケース：境界値パラメータで適切に処理される', () => {
      // 境界値での動作テスト
    });
  });
});
```

#### パターン2: プロパティアクセステスト

```typescript
describe('Given AglaError instance', () => {
  describe('When プロパティにアクセスする', () => {
    it('Then 正常系：有効プロパティで値が正常取得される', () => {
      // 正常なプロパティアクセステスト
    });

    it('Then 異常系：readonly制約でプロパティ変更が拒否される', () => {
      // プロパティ変更試行のエラーテスト
    });

    it('Then エッジケース：未定義プロパティでデフォルト値が返される', () => {
      // デフォルト値のテスト
    });
  });
});
```

#### パターン3: 機能統合テスト

```typescript
describe('Given AglaError chaining functionality', () => {
  describe('When エラーチェーン操作を実行する', () => {
    it('Then 正常系：有効エラーで正常チェーンが構成される', () => {
      // 正常チェーンテスト
    });

    it('Then 異常系：null/undefined原因でエラー処理される', () => {
      // 無効チェーンのエラーテスト
    });

    it('Then エッジケース：深いネストチェーンが適切に処理される', () => {
      // 複雑チェーンテスト
    });
  });
});
```

### テスト分類マッピング

#### コンストラクタ系（15テスト）

- **Given**: AglaError constructor
- **When**: エラーオブジェクトを作成する
- **Then**: 正常系(2) + 異常系(3) + エッジケース(2) = 7テスト
- **2サブグループに分割**: 基本パラメータ + オプション機能

#### プロパティ系（6テスト）

- **Given**: AglaError instance
- **When**: プロパティにアクセスする
- **Then**: 正常系(4) + 異常系(3) + エッジケース(2) = 9テスト
- **1サブグループ**: プロパティアクセス統合

#### JSON操作系（5テスト）

- **Given**: AglaError for serialization
- **When**: JSON変換操作を実行する
- **Then**: 正常系(3) + 異常系(2) + エッジケース(1) = 6テスト
- **1サブグループ**: シリアライゼーション統合

#### チェーン系（8テスト）

- **Given**: AglaError chaining functionality
- **When**: エラーチェーン操作を実行する
- **Then**: 正常系(4) + 異常系(2) + エッジケース(2) = 8テスト
- **1サブグループ**: チェーン機能統合

#### 継承系（6テスト）

- **Given**: AglaError inheritance
- **When**: Error継承機能を検証する
- **Then**: 正常系(3) + 異常系(2) + エッジケース(1) = 6テスト
- **1サブグループ**: 継承機能統合

#### バリデーション系（23テスト）

- **Given**: ErrorSeverity validation
- **When**: 重要度値をバリデーションする
- **Then**: 正常系(9) + 異常系(10) + エッジケース(4) = 23テスト
- **1サブグループ**: バリデーション統合

#### ファンクショナルテスト（4テスト）

- **Given**: complete workflows
- **When**: ワークフロー操作を実行する
- **Then**: 正常系(2) + 異常系(1) + エッジケース(1) = 4テスト
- **1サブグループ**: 統合ワークフロー

#### インテグレーションテスト（8テスト）

- **Given**: integration scenarios
- **When**: 統合シナリオを実行する
- **Then**: 正常系(3) + 異常系(3) + エッジケース(2) = 8テスト
- **2サブグループ**: 内部統合 + 外部統合

## 実装戦略

### フェーズ1: 構造設計確定

1. **新Given/When/Then構造の最終決定**
2. **各テスト分類の詳細マッピング完成**
3. **実装順序の決定（依存関係順）**

### フェーズ2: 段階的実装

1. **コンストラクタ系テスト** → 基盤テスト（最優先）
2. **プロパティ系テスト** → 基本機能テスト
3. **チェーン系 + 継承系** → 高度機能テスト
4. **JSON操作系** → データ変換テスト
5. **バリデーション系** → 入力検証テスト
6. **ファンクショナル + インテグレーション** → 統合テスト

### フェーズ3: 品質保証

1. **全テストケース実行確認**（既存94 + 追加分をすべて対象）
2. **カバレッジ測定・確認**（劣化なし）
3. **パフォーマンステスト**（実行時間維持）
4. **TypeScript型チェック + ESLint**（品質維持）

## 技術仕様

### テストファイル構造

```
src/__tests__/
├── AglaError.spec.ts                    # 48テスト → 新構造（件数は目安）
├── ErrorSeverity.spec.ts                # 23テスト → 新構造（件数は目安）
├── functional/
│   ├── AglaError.functional.spec.ts     # 2テスト → 新構造
│   └── ErrorSeverity.functional.spec.ts # 2テスト → 新構造
tests/integration/
├── AglaError.integration.spec.ts        # 5テスト → 新構造（件数は目安）
└── AglaError.external-systems.integration.spec.ts # 3テスト → 新構造（件数は目安）
```

### 実装ルール

#### 必須遵守事項

1. **既存テストロジックの保持**: 既存のテストロジック（expect文）は変更禁止
2. **3階層describe固定**: Given/When/Then の3階層構造を厳密に維持
3. **BDD記法統一**: atsushifx式BDD に完全準拠
4. **実行可能性確保**: 各段階でテスト実行確認必須
5. **テスト数方針**: 正常系/異常系/エッジケースの追加に伴うテスト増加を許容（重複は統合・冗長は排除）
6. **ランタイムガード/フォールバック**: 抽象層では実装しない。実装クラス/ファクトリ層でガード（throw）またはフォールバック（Unknownへ丸め）を採用し、必要な検証は機能/統合テストで行う。

#### コード変換パターン

```typescript
// 変換前（現在）
describe('AglaError constructor with valid parameters', () => {
  it('should create error instance correctly', () => {
    // テストコード
  });
});

// 変換後（新構造）
describe('Given AglaError constructor', () => {
  describe('When エラーオブジェクトを作成する', () => {
    it('Then 正常系：有効パラメータで正常作成される', () => {
      // 同じテストコード（変更なし）
    });
  });
});
```

## リスク管理

### 高リスク要素

- **R-001**: 既存テストロジック変更によるデグレード
- **R-002**: 複雑な依存関係による実装順序ミス
- **R-003**: 新構造での実行時間増加

### 対策

- **段階的実装**: 1セクションずつ完了・確認してから次へ
- **継続的テスト実行**: 各変更後に全テスト実行
- **バックアップ保持**: 各段階でのファイルバックアップ

## 成果物

### 主要成果物

1. **TODO.md更新版**: 新構造に基づく詳細実行計画（テスト増減方針反映）
2. **handover.md更新版**: 新構造の実装ガイド（増加許容方針反映）
3. **各テストファイル**: 新Given/When/Then構造適用版

### 品質指標

- **テスト数**: 既存94を起点に増加許容（品質優先、重複排除）
- **構造階層**: 3階層（固定）
- **分類整合性**: 95%以上
- **BDD準拠度**: 95%以上
- **実行時間**: ±5%以内（目安）

---

**作成日**: 2025-08-31\
**更新日**: 2025-08-31\
**ステータス**: 設計確定・実装準備完了
