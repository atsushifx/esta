---
title: はじめての Fixtures フレームワーク
description: E2E Fixtures Framework を使って最初のE2Eテストを作成するための導入ガイド
sidebar_position: 1
slug: /getting-started
---

## 第1章 はじめての Fixtures フレームワーク

E2E Fixture Framework は、ファイルベースでテストケースを記述・検証できる柔軟な E2E テストフレームワークです。
この章では、セットアップから最初のテスト実行までの流れを解説します。

### 1. セットアップ

#### 1.1 前提

E2E Fixtures Framework は、`ESTA` プロジェクトの一部として構成されています。そのため、以下の前提を満たす必要があります。

- テスト対象パッケージが、`@ag-utils/e2e-fixture-framework` を利用可能な `ESTA` モノレポ内に存在していること
- `pnpm` によるワークスペース環境が有効であること
- `Vitest` によるテストランナーを使用する構成が導入されていること

> `ESTA` 全体の構成や導入手順については、[オンボーディングドキュメント](../../../../../docs/onboarding/README.ja.md) を参照してください。

この章は「E2E Fixtures Framework を使ったテストの書き方」に焦点を当て、`Node.js` や `pnpm` のインストールといった環境構築の詳細は省略します。
`Node.js`、`pnpm`のインストールは、[オンボーディングドキュメント](../../../../../docs/onboarding/README.ja.md) を参照してください。

#### 1.2 パッケージのインストール

E2E Fixtures Framework を利用するには、テスト対象のパッケージに以下のように依存関係とスクリプトを追加します。
このフレームワークは、ESTA モノレポ内で `workspace:*` として管理されているため、ローカル開発中も即座に使用できます。

まず、`package.json` に次の内容を追加します。

```json
// package.json
{
  "scripts": {
    "test:ci": "pnpm exec vitest run --config ./configs/vitest.config.ci.ts"
  },
  "devDependencies": {
    "@ag-utils/e2e-fixture-framework": "workspace:*"
  }
}
```

次に、依存関係をインストールします。

```bash
pnpm install
```

この手順により、`@ag-utils/e2e-fixtures-framework` が導入され、E2E テストを記述・実行する準備が整います。

> 注意: vitest.config.ci.ts などの Vitest 設定ファイルが存在していない場合は、プロジェクト側で適切に用意してください。

### 2. Fixture の配置

E2E Fixtures Framework では、テストケースごとに **入力ファイルと出力ファイルのペア** をディレクトリに配置することで、テストを定義します。
これは「入力に対して期待される出力が得られるかどうか」を検証する、シンプルかつ明確な構造です。

#### 2.1 基本構成

E2E Fixture Framework では、各テストケースを個別のディレクトリで管理し、**そのなかに入力ファイルと期待される出力ファイルをペアで配置**する形式を採用しています。この構成によって、テストの内容が視覚的に把握しやすく、メンテナンス性も高くなります。

```bash
fixtures/
  └── basic/
      ├── input.md     ← テスト対象の入力ファイル
      └── output.json  ← 期待される出力
```

- `fixtures/` はテストフィクスチャ全体のルートディレクトリ
- その下に任意のケース名 (この例では `basic` )をディレクトリ名として作成。
- 各ディレクトリには、最低限 `input.*` と `output.json` の 2 ファイルが必要。

ファイル単位で「入力 → 出力」の変換を検証するスタイルのテストを、簡潔かつ明示的に記述できます。

> 大規模なテストケースや多段階の構文検証にも応用可能で、入力と出力の対応関係を明確に保つことができます。

#### 2.2 テストケース名

E2E Fixtures Framework における各テストケースは、**ディレクトリ名をそのままケース名**として使用します。このケース名は、テスト実行時のログ出力やエラーメッセージの識別に使われます。

**1階層ディレクトリの場合**:

```bash
fixtures/
  └── basic/
      ├── input.md
      └── output.json
```

この構成では、`basic` というケース名でテストが実行されます。

**ネストされた構成の場合**:

```bash
fixtures/
  └── advanced/
      └── nested/
          ├── input.md
          └── output.json
```

このように階層構造を取る場合でも、テストケース名は `advanced/nested` として認識され、テスト出力やエラーメッセージにそのまま表示されます。

> ケース名はファイルパスに基づいて決定されるため、カテゴリ別に階層化されたテストも自然に管理できます。
> これにより、数百を超える大規模なテストケースでも整理しやすくなり、メンテナンス性が向上します。

#### 2.3 拡張子の柔軟性

E2E Fixtures Framework では、入力ファイルの拡張子を柔軟に選択できます。テスト内容や対象形式に応じて `.md`, `.txt`, `.error` など、任意の拡張子を使用可能です。

**主な利用例**:

| 拡張子 | ファイル種別     | 用途                                           |
| ------ | ---------------- | ---------------------------------------------- |
| .md    | Markdown         | Markdown を入力とした見出し抽出などの検証      |
| .txt   | プレインテキスト | プレインテキストを処理対象とする変換系         |
| .error | void             | 異常系Fixture (エラーメッセージをチェックする) |

フレームワーク内部では、**ファイルの拡張子に応じて処理ロジック (パーサやバリデータ) を選択**する設計になっています。

> 独自の拡張子に対応したい場合は、パーサやバリデータのカスタマイズにより処理対象を拡張できます (詳細は[第6章](06-parsers-and-validators.ja.md)参照)。
> この柔軟性により、多様な形式・目的に応じたE2Eテストを構築できます。

#### 2.4 実行対象外のディレクトリ（`#` 付き）

テスト開発の途中で一時的に特定のテストケースをスキップしたい場合、**ディレクトリ名の先頭に `#` を付けることで、そのディレクトリを実行対象から除外**できます。

##### **使用例**

```bash
fixtures/
  ├── basic/           # 実行対象
  ├── \#draft-case/     # 実行されない
```

この構成では、`basic` のみがテスト対象となり、`#draft-case` ディレクトリ内のケースは **無視されます**。

##### **特徴と利点**

- 一時的に無効化したいケースや作業中のケースを簡易に管理できる
- `runAllFoundTests()` 実行時にも自動でスキップされるため、明示的な除外設定は不要
- 複数人開発時にも、未完成のフィクスチャを安全に保持しておける

> コメントアウト的な扱いとして使えるこの機能は、テスト開発のスピードと柔軟性を両立させるうえで非常に便利です。

### 3. 最初の`fixture`を書いてみる

ここでは、実際に E2E Fixtures Framework を使って、最初のテスト Fixture を作成する手順を紹介します。

#### 3.1 `fixtures`の例

最初のテストケースとして、`fixtures/basic/` ディレクトリにシンプルな入力・出力ファイルを用意します。
ここでは Markdown の見出しを抽出する処理を仮定した例を紹介します。

ファイル構成:

```bash
fixtures/
  └── basic/
      ├── input.md
      └── output.json
```

`fixtures/basic/input.md`:

```markdown
# サンプル入力

これはテスト用のマークダウンです。
```

- テスト対象の入力として、1つの見出しを含む Markdown テキストを記述

`fixtures/basic/output.json`:

```json
{
  "type": "markdown",
  "ast": {
    "headers": ["サンプル入力"]
  }
}
```

- パーサによって抽出されるべき出力結果を JSON 形式で記述
- この例では、Markdown の見出しが headers 配列に格納されているかどうかを検証

> 入力と出力をファイル単位で定義するこのスタイルは、**視認性が高く保守しやすい**テスト設計に適しています。

### 3.2 テストファイルを作る

`fixtures/` ディレクトリにテストケースを定義したら、それらを実行するテストファイルを作成します。
E2E Fixture Framework では、テストスクリプトの記述量を最小限に抑えることができます。

#### テストスクリプト例

```ts
// tests/e2e/framework.e2e.spec.ts
// vitest
import { describe } from 'vitest';

// E2E Fixtures Framework
import { AgE2eFixturesFramework } from '@ag-utils/e2e-fixtures-framework';

// テスト対象関数
import { testFunction } from '../testFunction';

const framework = new AgE2eFixturesFramework(testFunction);

describe('E2E Fixture Framework 基本テスト', () => {
  framework.runAllFoundTests('fixtures');
});
```

#### 説明

- `AgE2eFixturesFramework` は、与えられたテスト関数　(ここでは `testFunction`) に対して、入力と出力の検証を自動で行うラッパークラス。
- `runAllFoundTests()` は、指定されたディレクトリ (`fixtures/`) 以下のすべてのテストケースを再帰的に探索し、自動でテストを構築・実行。
  (ディレクトリ名は自由に変更可能だが、実際のフィクスチャ配置に合わせて適宜調整する必要がある。)
- `describe()` を使って、テストスイート全体に意味のあるラベルを付与することで、出力ログが明確になる。

> フィクスチャの追加・更新を行っても、**テストスクリプトの変更は不要**です。常に最新のテストケースを網羅的に
> 実行できる構成になります。

### 4. テストの実行

作成したテストスクリプトを実行し、結果を確認します。

#### 4.1 テストスクリプトの実行

作成したテストスクリプトが正しく動作するか確認するため、対象パッケージのルートディレクトリで次のコマンドを実行します。

```bash
pnpm run test:ci
```

このコマンドは、事前に package.json に定義した `test:ci` スクリプトを呼び出します。
スクリプトは、`vitest` を使って `tests/e2e/`下の`framework.e2e.spec.ts` を実行します。

この関数は `fixtures/`下のすべてのテストケースを再帰的に探索し、各入力と出力の一致を検証します。

package.json の例 (再掲):

```json
// package.json の該当箇所（再掲）
{
  "scripts": {
    "test:ci": "pnpm exec vitest run --config ./configs/vitest.config.ci.ts"
  }
}
```

> `vitest.config.ci.ts` の内容やロケーションは、プロジェクトの構成に応じて調整してください。
> CI 環境向けにログ出力や実行条件を切り分ける設計が推奨されます。

テストケースが 1件でも存在すれば、それに基づいて自動的にテストが実行され、**成功・失敗のログが明示的に出力されます**。

この簡潔な実行フローにより、複数の E2E フィクスチャを手動で記述・実行する手間を省き、**保守性と信頼性の高いテスト運用**が可能になります。

#### 4.2 成功時の出力

テストが正常に実行され、期待される出力と一致した場合、Vitest によって以下のような出力が表示されます。

```bash
✓ E2E Fixture Framework 基本テスト > fixtures/basic
```

この出力は以下の情報を示しています。

- `✓` はテストが成功したことを表すマーク
- `E2E Fixtures Framework 基本テスト` は、`describe()` で指定したテストスイートの名前
- `fixtures/basic` は、実行されたテストケースの名前 (＝ディレクトリパス)

> Fixtures の構成に問題がなければ、すべてのケースがこのように `✓` マーク付きで表示されます。

このログにより、**どのケースが成功したかが視覚的に明確になり、テスト結果の把握が容易になります**。

#### 4.3 失敗時の出力

期待される出力と実際の出力が一致しない場合、Vitest によって以下のようなエラーログが表示されます。

```bash
✘ E2E Fixture Framework 基本テスト > fixtures/basic
   Error: Validation failed in case: basic
   Expected: ["サンプル入力"]
   Received: ["Sample"]
```

この出力は以下の点を示しています。

- `✘` はテストが失敗したことを示すマーク
- `fixtures/basic` は失敗したテストケースのパス
- `Expected` と `Received` によって、期待されていた値と実際の出力の差分を明示

##### **よくある原因**

- `output.json` の記述ミス (余分な空白や誤ったキー名など)
- 対象処理関数 (`testFunction`) の実装ミス
- 入力ファイル (`input.md`) の記述不足や誤り

> 差分表示によって失敗原因の特定が容易になり、構造化データの検証や出力設計の改善にも役立ちます。

#### 4.4 ヒント

E2E Fixtures Framework の基本的な構成と実行フローに慣れれば、大量のテストケースも効率的に扱えるようになります。
以下は運用時の便利なポイントです。

<!-- textlint-disable ja-technical-writing/sentence-length -->

1. **Fixture の追加はファイル作成だけで完了**
   新しいテストケースを追加する場合は、`fixtures/` 配下に新しいディレクトリを作り、`input.*` と `output.json` を配置するだけで OK。テストスクリプトの変更は不要。

2. **`runAllFoundTests()` が全件自動処理**
   テスト関数を変更しない限り、どれだけ Fixture が増えてもスクリプトはそのまま使える。

3. **`#` 付きディレクトリはスキップ対象**
   試作中や除外したいケースは、ディレクトリ名の先頭に `#` をつけることで、テストから一時的に除外。

4. **ログ出力で差分が明示される**
   失敗時には `Expected` と `Received` が表示されるため、出力の不一致箇所を素早く把握できる。

<!-- textlint-enable -->

> E2E Fixtures Framework は「入力ファイルと出力ファイルを置けばすぐに試せる」設計です。
> 使いこなせば、回帰テストや仕様確認の手間を削減できます。

### まとめ

- フレームワークは「入力ファイルと出力ファイルのペア」をもとにテストを実行する仕組み
- `fixtures/` 以下にディレクトリを作成し、`input.*` と `output.json` を配置すればテストケースが定義される
- テストスクリプトは `runAllFoundTests()` を使えば、記述は最小限で済む。
- `pnpm run test:ci` により、すべてのテストケースが一括で実行される。
- 失敗時には差分が明示され、迅速なデバッグが可能
- `#` を先頭に付けたディレクトリはスキップ対象となるため、柔軟なケース管理が可能

> この章を完了することで、基本的なセットアップと最小構成のE2Eテストを実行できる状態となります。
