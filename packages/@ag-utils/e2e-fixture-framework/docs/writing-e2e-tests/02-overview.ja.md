---
title: フレームワーク全体像
description: E2E Fixture Framework の設計思想、構成、テスト実行の流れを解説します。
sidebar_position: 2
slug: /overview
---

## 第2章 フレームワーク全体像

この章では、E2E Fixture Framework の設計思想と構成要素、そしてフィクスチャを用いたテスト処理の流れについて解説します。

### 1. 設計の目的

<!-- textlint-disable ja-technical-writing/sentence-length -->

E2E Fixture Framework は、ESTA モノレポ内の各パッケージで、**共通化された E2E テスト戦略**を導入するために開発されました。
従来のユニットテストや統合テストではカバーしづらい構文変換や「テキスト入力に対する出力検証」などの処理に対し、ファイルベースで再現性の高い形式によりテストケースを管理・実行することを目的としています。

<!-- textlint-enable -->

#### 1.1 主な目的

- **テストデータ (input/output) をコードから分離**
  → テストケースをファイル単位で管理でき、コードと分離されるため見通しがよくなる

- **同じ処理に対して複数のケースを網羅的に検証**
  → `Fixture` を追加するだけでテストの網羅性を高められる

- **構文解析・変換処理などの複雑なロジックを対象に、出力の安定性を保証**
  → Markdown の構文抽出や AST の整合性など、曖昧さのない検証が可能になる

- **テストケースの追加・変更が簡単で再現性の高い構造**
  → 入出力のファイルを定義するだけで新しいケースが自動的に検出され、再利用性が向上する

> 複雑な構造の出力やエラーパターンも、JSON や構造化された形式で明示的に管理できるため、保守性にも優れています。

### 2. 構成要素の概要

E2E Fixtures Framework は、複数のモジュールとファイル構造によって構成されています。
各構成要素の役割は明確に分離されており、柔軟なカスタマイズと再利用が可能です。

| コンポーネント          | 役割                                                                             |
| ----------------------- | -------------------------------------------------------------------------------- |
| `AgE2eFixtureFramework` | フレームワーク本体。テスト対象関数とフィクスチャ群を組み合わせて実行する         |
| `AgE2eFileReader`       | 各テストケースの `input.*` および `output.json` を読み込むユーティリティ         |
| `fixtureRunner`         | 入出力データを使ってテスト関数を実行し、結果をバリデートするロジック             |
| `parsers/`              | 各ファイル形式に応じた入力データのパーサを定義。Markdown, PlainText 等が解釈する |
| `validators/`           | 各ファイル形式に応じた出力検証のロジックを定義。Markdown, PlainText 等が含まれる |

この構成により、テスト作成者は「テスト対象の処理」と「フィクスチャの定義」に集中できます。
検証ロジックやファイル読み込み処理は、フレームワークが自動的に実行します。

> テスト構築の手間を最小限に抑えつつ、高度な検証が可能な設計です。

### 3. テストの処理フロー

E2E Fixture Framework は、入力ファイルと出力ファイルに基づいて、明確なステップでテストを処理します。
以下は 1 ケースにおける基本的なフローです。

1. `fixtures/` 配下に `input.md` と `output.json` を用意

2. `runAllFoundTests()` によって対象ディレクトリを再帰的に探索

3. 各ケースに対して、以下の処理を順に実行

   ```plaintext
   [fixtures/basic/input.md]
     ↓
   [AgE2eFileReader] で読み取り
     ↓
   [AgE2eFixtureFramework] が testFunction を実行
     ↓
   [validator] によって output.json との一致を検証
   ```

このように、**ファイル準備 → 読み込み → 関数実行 → 結果検証** という流れが、すべてのテストケースに対して統一的に適用されます。

> 各ケースで個別にコードを書く必要はなく、テスト関数とフィクスチャを用意するだけで自動的にテストが構築されます。

### 4. テストケースの考え方

E2E Fixtures Framework におけるテストケースは、**「入力と期待される出力を並べて保存するだけ」**というシンプルな設計思想に基づいています。

- `input.md` などの入力ファイルと、`output.json` の出力ファイルをペアで定義する
- ケースごとにディレクトリを分け、明確な構造で管理する
- 検証には validator が使われ、出力の一致・整合性をチェックする

#### 4.1 validator の柔軟性

E2E Fixtures Framework は入力データごとに異なる Validator を使用できます。

- 出力検証には、形式ごとに対応する validator を適用できる
- Markdown のヘッダー抽出、PlainText の改行数検証など、目的に応じたカスタマイズが可能
- 複数形式に対応した検証戦略を構築することで、実際の仕様に即したテストが可能になる

#### 4.2 出力フォーマットの自由度

出力結果は、`fixtures/../output.json` と比較して検証します。
`output.json`は自由に設定できます。

- `output.json` の構造は任意で定義でき、対象処理に合わせた AST や構造情報も記述可能
- 複雑な変換処理やネスト構造の出力にも対応できる柔軟な設計

> 「テストを書くこと」は「出力をどう定義し、どう検証するか」という思想設計と同義であり、
> このフレームワークはそれを視覚的に、かつ再利用可能なかたちで支援します。

### 5. 推奨ディレクトリ構造

E2E Fixtures Framework は、多数のテストケースを整理・保守しやすくするために、**カテゴリ単位での階層構造**を推奨しています。

```bash
tests/
├── e2e/
│   ├── framework.e2e.spec.ts        ← テストスクリプト (全fixture を対象)
│   └── fixtures/                    ← フィクスチャのベースディレクトリ
│       ├── markdown/                ← 大分類 (例：Markdown パーサ用)
│       │   ├── headings/            ← 中分類 (例：見出し抽出)
│       │   │   └── simple-h1/       ← テストケース名 (1ケース1ディレクトリ)
│       │   │       ├── input.md
│       │   │       └── output.json
│       │   └── links/
│       │       └── nested-links/
│       └── plaintext/
│           └── line-count/
│               └── basic-case/
```

#### 5.1 ポイント

- `fixtures/`以下を **大分類 / 中分類 / ケース名** で構成すると整理がしやすく、スケールにも耐えやすい

- `runAllFoundTests()` は、**ベースディレクトリから2階層下までを再帰的に自動検出**するため、分類構成と実行対象が自然に一致する

- ログやエラーメッセージには、フォルダ名がそのままケース名として出力される

#### 5.2 テストのスキップ

- 一時的に実行対象から除外したい場合は、ディレクトリ名の先頭に `#` を付ける

  ```plaintext
  fixtures/
  └── markdown/
       └── #drafts/
          └── old-case/
  ```

この方法により、作業中のケースや保留中のテストを簡単に管理し、実行から除外できます。
また、複数人で開発する際にも、影響範囲を明示的に制御できるため、チーム開発でも安全です。

> しっかりとしたディレクトリ設計は、テストの保守性と開発効率に直結します。最初に構造を整えておくことを推奨します。

### まとめ

E2E Fixtures Framework の全体像は、次の通りです。

- 入出力ファイルを用いたファイルベースのテスト記述が可能なフレームワークク
- `AgE2eFixtureFramework`・`AgE2eFileReader`・`fixtureRunner` などの構成要素が役割を分担し、柔軟なテスト実行を支える
- `runAllFoundTests()` により `fixtures` 以下を自動検出し、全ケースを実行・検証
- validator を差し替えることで、柔軟な検証ロジックに対応
- 推奨ディレクトリ構成に従うことで、大規模なテストケースも保守しやすく、カテゴリ単位の整理が可能
- `#` を先頭に付けたディレクトリは自動でスキップされるため、作業中のケースを安全に分離可能

> 本章の内容を理解することで、E2E Fixtures Framework の設計意図とテスト実行の全体像が掴めるようになります。
> 次章では、より実践的なプロジェクト構成とテストファイルの配置ルールを解説します。
