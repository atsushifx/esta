---
title: monorepo構成と、その実現方法
description: pnpm-workspacesを用いたmonorepo構成の概要と利点を初心者向けに解説します。
sidebar_position: 6
---

## 6 monorepo構成と、その実現方法

### 6.1 monorepoの概要

monorepo（モノレポ）とは、複数の関連するプロジェクトやパッケージを 1 つのリポジトリで管理する開発手法です。
従来の複数リポジトリ管理（マルチレポ）と異なり、コードの共有やバージョン整合性を保ちやすいのが特徴です。

### 6.2 本リポジトリのmonorepo構成

#### ディレクトリ構成

本リポジトリでは、ディレクトリ構造は以下のようになっています。
このなかの、`/packages/@ag-actions/`下の`tool-installer`や`/packages/@ag-utils/`下の`command-utils`がサブパッケージです。

```bash
/
|-- configs
|-- packages
|   |-- @ag-actions
|   |   `-- tool-installer
|   |       |-- configs
|   |       |-- shared
|   |       `-- tests
|   |-- @ag-system
|   |   `-- fatal-exit
|   |       `-- shared
|   `-- @ag-utils
|       |-- command-utils
|       |   `-- configs
|       |-- common
|       |   `-- configs
|       `-- get-platform
|           `-- configs
|-- scripts
`-- shared
    |-- common
    |   |-- configs
    |   |-- constants
    |   `-- types
    `-- configs
```

#### `monorepo`の実現方法

本リポジトリでは、`pnpm`の`workspaces`機能によって monorepo を実現しています。
リポジトリルートに`pnpm-workspace.yaml`を作成し、以下のように設定します。

```yaml
# src; pnpm-workspace.yaml
# @(#) : pnpmによるmonorepo設定
packages:
  - apps/**
  - packages/**
  - shared/**
```

これにより、`/app/`下、`/packages`下、`/shared/`下のディレクトリがサブリポジトリとして使えるようになります。
たとえば、`/packages/@ag-utils/command-util'ディレクトリに`package.json`を設置すると、そのディレクトリがサブリポジトリとなります。
サブリポジトリは、通常のリポジトリと同様に設定、開発、運用ができます。

### 6.3 monorepoのポイントと利点

- **一元管理**
  すべてのパッケージやツールが単一のリポジトリで管理されるため、依存関係やバージョン管理が容易になります。

- **コード共有**
  `shared` や `common` といった共通モジュールを容易に利用でき、重複実装を防げます。

- **一括ビルド・テスト**
  複数パッケージのビルドやテストを一度に実行できるため、開発効率が向上します。

- **依存関係の最適化**
  pnpm-workspaces がパッケージ間の依存関係を賢く解決し、インストール時間やディスク容量を節約します。

- **統一された開発環境**
  設定ファイルや CI/CD の管理が一本化されるため、一貫性が高まります。

- **依存関係の管理が簡単**
  サブパッケージ間の依存も自動解決され、リンクが効率的に行われます。

- **バージョン管理の一貫性**
  同一リポジトリ内で統一された管理が可能です。

- **一括スクリプトの実行**
  ルートから全パッケージを対象にビルドやテストをまとめて実行できます。

- **設定ファイルの共通化がしやすい**
  共有ディレクトリの設定を各パッケージで参照・拡張できます。

### 6.4 注意点とベストプラクティス

- **パッケージ間の依存循環に注意**
  相互依存が複雑になると管理が難しくなるため、設計段階で依存関係を明確にしましょう。

- **CI/CD環境の設定**
  モノレポの特徴を活かした CI 設定を用意し、効率的にビルドやテストを行うことが推奨されます。

- **パッケージの独立性確保**
  可能な限りパッケージは独立して機能するように設計し、不要な結合度を下げると保守性が向上します。

### 6.4 チェックポイント

monorepo 運用にあたって、以下のポイントを押さえることが重要です。

- パッケージ間の依存関係が明確で、不要な循環依存を避けていること
- CI/CD の構成がモノレポに最適化されていること
- 各パッケージの独立性が保たれ、保守性が高いこと
- 共通設定ファイルが適切に共有・拡張されていること
- ルートおよび各パッケージでのスクリプト管理が整理されていること

#### モノレポ活用のためのチェック項目

- [ ] パッケージの依存関係グラフを作成し、循環参照がないことを確認
- [ ] ルートディレクトリから各パッケージのビルドやテストが一括実行可能
- [ ] CI/CD パイプラインがモノレポ構成に対応して効率的に動作している
- [ ] 共有設定ファイル（eslint, tsconfig など）がすべての関連パッケージで参照・利用されている
- [ ] 個別パッケージで必要な設定拡張が適切に行われている
- [ ] `package.json` のスクリプトがルート用とサブパッケージ用に整理されている
- [ ] 不要なパッケージの重複インストールや依存解決が発生していない
- [ ] 開発メンバーがモノレポ構成と運用ルールを理解している
