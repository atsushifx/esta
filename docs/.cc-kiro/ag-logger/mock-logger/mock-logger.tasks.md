---
header:
  - src: mock-logger.tasks.md
  - "@(#)": MockLogger リファクタリングタスク一覧
title: MockLogger リファクタリングタスク一覧
description: t-wada式TDDによるMockLoggerリファクタリングの実装タスク詳細
version: 1.0.0
created: 2025-07-25
updated: 2025-07-25
authors:
  - atsushifx
changes:
  - 2025-07-25: 初回作成（ドキュメント整備）
copyright:
  - Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
  - This software is released under the MIT License.
  - https://opensource.org/licenses/MIT
---

## 概要

本タスクドキュメントは、MockLogger リファクタリングを t-wada式TDD（テスト駆動開発）および BDD（ビヘイビア駆動開発）により実装するための詳細タスクリストを定義する。各タスクは「Red → Green → Refactoring」サイクルに従い、1つずつ完成させる。

## 実装方針

### 開発手法

- t-wada式TDD による実装
- BDD による Describe/It を使用したテスト記述
- 1タスクごとの完全実装（Red → Green → Refactoring）
- 失敗するテストから開始し、最小実装で成功させる

### テスト方針

- ユニットテスト：個別機能の詳細検証
- 統合テスト：クラス間の相互作用検証
- E2Eテスト：実使用パターンでの動作検証

## Phase 1: 基盤実装（エラー系・ユーティリティ）

### Task 1.1: エラーメッセージ定数の実装

**目的**: エラーメッセージの一元管理基盤を構築する

**ファイル**: `shared/constants/errorMessages.ts`

**詳細タスク**:

1. **テスト作成**: エラーメッセージ定数の存在確認テスト
   - `MOCK_LOGGER_ERROR_MESSAGES.VALIDATION.INVALID_LOG_LEVEL` の定義確認
   - `MOCK_LOGGER_ERROR_MESSAGES.STATE.BUFFER_NOT_FOUND` の定義確認
   - `MOCK_LOGGER_ERROR_MESSAGES.RESOURCE.BUFFER_OVERFLOW` の定義確認

2. **最小実装**: 必要なエラーメッセージ定数を実装
   - VALIDATION カテゴリのメッセージ定義
   - STATE カテゴリのメッセージ定義
   - RESOURCE カテゴリのメッセージ定義

3. **テスト作成**: getErrorMessage ヘルパー関数のテスト
   - 正常系：既存キーでのメッセージ取得
   - 異常系：存在しないキーでのデフォルトメッセージ取得

4. **実装**: getErrorMessage ヘルパー関数の実装
5. **リファクタリング**: 型安全性の向上とコードの最適化

**受入条件**:

- 全エラーメッセージが定数として定義されている
- getErrorMessage が正常に動作する
- 型安全なアクセスが可能である

### Task 1.2: ベースエラークラスの実装

**目的**: 統一されたエラーハンドリング基盤を構築する

**ファイル**: `shared/types/mockLogger.types.ts`

**詳細タスク**:

1. **テスト作成**: AglaError抽象クラスのテスト
   - code プロパティの設定確認
   - context プロパティの設定確認
   - toString() メソッドの動作確認

2. **最小実装**: AglaError 抽象クラスの実装
   - Error クラスの継承
   - code, context プロパティの実装
   - コンストラクタの実装

3. **テスト作成**: スタックトレース調整のテスト
4. **実装**: Error.captureStackTrace の実装
5. **リファクタリング**: エラー情報の文字列化メソッドの最適化

**受入条件**:

- AglaError が正常に継承可能である
- エラー情報が適切に設定される
- スタックトレースが正常に表示される

### Task 1.3: 専用エラークラスの実装

**目的**: MockLogger専用のエラーハンドリングを構築する

**ファイル**: `types/mockLogger.types.ts`

**詳細タスク**:

1. **テスト作成**: MockLoggerValidationError のテスト
   - AglaError からの正常継承確認
   - VALIDATION_ERROR コードの設定確認
   - context 情報の設定確認

2. **最小実装**: MockLoggerValidationError クラス
3. **テスト作成**: MockLoggerStateError のテスト
4. **実装**: MockLoggerStateError クラス
5. **テスト作成**: MockLoggerResourceError のテスト
6. **実装**: MockLoggerResourceError クラス
7. **リファクタリング**: 共通処理の抽出と最適化

**受入条件**:

- 各エラークラスが適切なコードを持つ
- context 情報が正常に設定される
- エラーメッセージ定数との連携が動作する

### Task 1.4: 検証ユーティリティの実装

**目的**: 型安全な入力検証機能を構築する

**ファイル**: `utils/validationUtils.ts`

**詳細タスク**:

1. **テスト作成**: validateLogLevel のテスト
   - 正常系：有効なログレベル（0-6）の検証
   - 異常系：無効な型（文字列、null、undefined）での例外
   - 異常系：範囲外数値（-1、7）での例外

2. **最小実装**: validateLogLevel 関数
3. **テスト作成**: validateMessage のテスト
   - 正常系：文字列メッセージの検証
   - 異常系：非文字列での例外

4. **実装**: validateMessage 関数
5. **テスト作成**: validateTestId のテスト
   - 正常系：有効なtestIdの検証とトリム
   - 異常系：空文字列、255文字超過での例外

6. **実装**: validateTestId 関数
7. **リファクタリング**: エラーメッセージ定数との統合と最適化

**受入条件**:

- 全検証関数が正常系・異常系で動作する
- 適切なエラーメッセージが表示される
- 型安全な検証が実現されている

## Phase 2: LogBufferManager の実装

### Task 2.1: LogBufferManager基本構造の実装

**目的**: ログバッファ管理の中核機能を構築する

**ファイル**: `core/LogBufferManager.ts`

**詳細タスク**:

1. **テスト作成**: コンストラクタとバッファ初期化のテスト
   - 全ログレベル（0-6）のバッファ作成確認
   - 初期状態で空配列であることの確認

2. **最小実装**: LogBufferManager クラスの基本構造
   - プライベート buffers マップの実装
   - initializeBuffers メソッドの実装

3. **テスト作成**: MAX_BUFFER_SIZE 定数のテスト
4. **実装**: MAX_BUFFER_SIZE = 1000 の定義
5. **リファクタリング**: 初期化処理の最適化

**受入条件**:

- 全ログレベルのバッファが初期化される
- MAX_BUFFER_SIZE が適切に設定される
- メモリ効率的な初期化が実現される

### Task 2.2: メッセージ追加機能の実装

**目的**: バッファオーバーフロー検出付きのメッセージ追加機能を構築する

**ファイル**: `core/LogBufferManager.ts`

**詳細タスク**:

1. **テスト作成**: addMessage 正常系のテスト
   - 各ログレベルへのメッセージ追加確認
   - バッファ内容の正確性確認

2. **最小実装**: addMessage メソッドの基本機能
3. **テスト作成**: 無効ログレベルでの例外テスト
   - MockLoggerValidationError のスロー確認
   - エラーメッセージ定数の使用確認

4. **実装**: ログレベル検証とエラーハンドリング
5. **テスト作成**: バッファオーバーフローのテスト
   - 1000件到達時の MockLoggerResourceError 確認
   - context 情報の詳細確認

6. **実装**: バッファオーバーフロー検出機能
7. **リファクタリング**: エラーハンドリングの最適化

**受入条件**:

- メッセージが正確にバッファに追加される
- バッファオーバーフロー時に適切なエラーが発生する
- エラー情報に十分なcontext が含まれる

### Task 2.3: メッセージ取得機能の実装

**目的**: 防御的コピーによる安全なメッセージアクセス機能を構築する

**ファイル**: `core/LogBufferManager.ts`

**詳細タスク**:

1. **テスト作成**: getMessages のテスト
   - 各ログレベルのメッセージ取得確認
   - 防御的コピーの動作確認（元バッファの変更が影響しない）

2. **最小実装**: getMessages メソッド
3. **テスト作成**: getAllMessages のテスト
   - 全レベルのメッセージ取得確認
   - Record型での正確な返却確認

4. **実装**: getAllMessages メソッド
5. **テスト作成**: 無効ログレベルでの例外テスト
6. **実装**: エラーハンドリングの追加
7. **リファクタリング**: メモリ効率の最適化

**受入条件**:

- メッセージが防御的コピーで取得される
- 全ログレベルの一括取得が可能である
- 外部からの変更がバッファに影響しない

### Task 2.4: 検索機能の実装

**目的**: 柔軟なパターンマッチングによるメッセージ検索機能を構築する

**ファイル**: `core/LogBufferManager.ts`

**詳細タスク**:

1. **テスト作成**: createMatcher ヘルパーのテスト
   - 文字列パターンでの部分一致確認
   - 正規表現パターンでのマッチング確認

2. **最小実装**: createMatcher プライベートメソッド
3. **テスト作成**: findMessages のテスト
   - 特定レベルでの検索確認
   - 全レベル検索の確認
   - 空結果の処理確認

4. **実装**: findMessages メソッド
5. **テスト作成**: hasMessage のテスト
   - 存在確認の正確性テスト
   - パフォーマンス（早期終了）の確認

6. **実装**: hasMessage メソッド
7. **リファクタリング**: 検索処理の最適化

**受入条件**:

- 文字列・正規表現での検索が動作する
- 特定レベル・全レベル検索が可能である
- 存在確認が効率的に動作する

### Task 2.5: バッファ管理機能の実装

**目的**: バッファクリアとメタ情報取得機能を構築する

**ファイル**: `core/LogBufferManager.ts`

**詳細タスク**:

1. **テスト作成**: clear メソッドのテスト
   - 特定レベルクリアの確認
   - 全レベルクリアの確認
   - クリア後の状態確認

2. **最小実装**: clear メソッド
3. **テスト作成**: getMessageCount のテスト
   - 各レベルのメッセージ数取得確認
   - 空バッファでの0件確認

4. **実装**: getMessageCount メソッド
5. **テスト作成**: cleanup のテスト
   - 全バッファの完全削除確認
   - cleanup後の状態確認

6. **実装**: cleanup メソッド
7. **リファクタリング**: メモリ管理の最適化

**受入条件**:

- バッファクリアが正常に動作する
- メッセージ数が正確に取得される
- cleanup で完全なリソース解放が行われる

## Phase 3: MockLogger のリファクタリング

### Task 3.1: MockLogger基本構造の実装

**目的**: LogBufferManager への委譲構造を構築する

**ファイル**: `plugins/logger/MockLogger.ts`

**詳細タスク**:

1. **テスト作成**: コンストラクタのテスト
   - LogBufferManager の正常な初期化確認
   - 初期状態での空バッファ確認

2. **最小実装**: MockLogger クラスの基本構造
   - bufferManager プロパティの実装
   - コンストラクタでの初期化

3. **テスト作成**: 依存関係のテスト
   - LogBufferManager への委譲確認

4. **リファクタリング**: 構造の最適化

**受入条件**:

- LogBufferManager が正常に初期化される
- 委譲パターンが適切に実装される

### Task 3.2: ログ出力メソッドの実装

**目的**: 各ログレベルの出力メソッドを委譲パターンで実装する

**ファイル**: `plugins/logger/MockLogger.ts`

**詳細タスク**:

1. **テスト作成**: fatal メソッドのテスト
   - メッセージの正常な記録確認
   - LogBufferManager への委譲確認

2. **最小実装**: fatal メソッド
3. **テスト作成**: error, warn, info, debug, trace メソッドのテスト
4. **実装**: 残りのログ出力メソッド
5. **テスト作成**: 各レベルの分離確認テスト
6. **リファクタリング**: 共通処理の最適化

**受入条件**:

- 全ログレベルのメソッドが動作する
- メッセージが適切なレベルに記録される
- LogBufferManager との連携が正常である

### Task 3.3: バッファアクセスAPIの実装

**目的**: 既存API互換のバッファアクセス機能を実装する

**ファイル**: `plugins/logger/MockLogger.ts`

**詳細タスク**:

1. **テスト作成**: getMessages のテスト
   - 各レベルのメッセージ取得確認
   - 既存APIとの互換性確認

2. **最小実装**: getMessages メソッド
3. **テスト作成**: getAllMessages のテスト
4. **実装**: getAllMessages メソッド
5. **テスト作成**: clearMessages のテスト
   - 特定レベル・全レベルクリア確認

6. **実装**: clearMessages メソッド
7. **テスト作成**: getMessageCount のテスト
8. **実装**: getMessageCount メソッド
9. **リファクタリング**: API の統一性確保

**受入条件**:

- 既存APIとの完全な互換性を持つ
- バッファアクセスが正常に動作する
- メソッド名が既存と一致する

### Task 3.4: 検索APIの実装

**目的**: 既存API互換の検索機能を実装する

**ファイル**: `plugins/logger/MockLogger.ts`

**詳細タスク**:

1. **テスト作成**: findMessages のテスト
   - 文字列・正規表現での検索確認
   - レベル指定・全レベル検索確認

2. **最小実装**: findMessages メソッド
3. **テスト作成**: hasMessage のテスト
   - 存在確認の正確性テスト

4. **実装**: hasMessage メソッド
5. **テスト作成**: 既存APIとの互換性テスト
6. **リファクタリング**: 検索機能の最適化

**受入条件**:

- 検索機能が既存APIと互換である
- 文字列・正規表現での検索が動作する
- パフォーマンスが適切である

### Task 3.5: リソース管理の実装

**目的**: 明示的なリソース管理機能を実装する

**ファイル**: `plugins/logger/MockLogger.ts`

**詳細タスク**:

1. **テスト作成**: cleanup のテスト
   - LogBufferManager のクリーンアップ確認
   - cleanup後の状態確認

2. **最小実装**: cleanup メソッド
3. **テスト作成**: cleanup後のメソッド動作テスト
4. **リファクタリング**: エラーハンドリングの追加

**受入条件**:

- cleanup が正常に動作する
- メモリリークが発生しない
- 適切なエラーハンドリングがある

## Phase 4: E2eMockLogger の再設計

### Task 4.1: E2eMockLogger基本構造の実装

**目的**: testId ベースの新構造を構築する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: コンストラクタのテスト
   - testId の正常な設定確認
   - 静的Map への登録確認

2. **最小実装**: E2eMockLogger クラスの基本構造
   - 静的 testBuffers Map の実装
   - testId プロパティの実装

3. **テスト作成**: testId バリデーションのテスト
   - 有効なtestId での正常処理確認
   - 無効なtestId での例外確認

4. **実装**: validateTestId プライベートメソッド
5. **リファクタリング**: 初期化処理の最適化

**受入条件**:

- testId が適切に検証・設定される
- 静的管理が正常に動作する
- エラーハンドリングが適切である

### Task 4.2: テストバッファ管理の実装

**目的**: testId ごとの独立したバッファ管理を実装する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: initializeTestBuffer のテスト
   - 新規testId でのバッファ作成確認
   - 既存testId での重複防止確認

2. **最小実装**: initializeTestBuffer メソッド
3. **テスト作成**: getBufferManager のテスト
   - 正常系：バッファマネージャーの取得確認
   - 異常系：存在しないtestId での例外確認

4. **実装**: getBufferManager メソッド
5. **テスト作成**: 複数testId での分離確認テスト
6. **リファクタリング**: バッファ管理の最適化

**受入条件**:

- testId ごとに独立したバッファが作成される
- バッファの分離が正常に動作する
- 適切なエラーハンドリングがある

### Task 4.3: ログ出力メソッドの実装

**目的**: testId 分離されたログ出力機能を実装する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: 各ログレベルメソッドのテスト
   - testId 分離での正常な記録確認
   - 異なるtestId 間での独立性確認

2. **最小実装**: 全ログ出力メソッド（fatal, error, warn, info, debug, trace）
3. **テスト作成**: バッファマネージャー連携のテスト
4. **リファクタリング**: 共通処理の抽出

**受入条件**:

- 全ログレベルが独立して動作する
- testId 分離が確実に実現される
- バッファマネージャーとの連携が正常である

### Task 4.4: メッセージアクセスAPIの実装

**目的**: testId 分離されたメッセージアクセス機能を実装する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: getMessages のテスト
   - testId 分離でのメッセージ取得確認
   - 他のtestId への影響がないことの確認

2. **最小実装**: getMessages メソッド
3. **テスト作成**: getAllMessages, clearMessages のテスト
4. **実装**: getAllMessages, clearMessages メソッド
5. **テスト作成**: getMessageCount のテスト
6. **実装**: getMessageCount メソッド
7. **リファクタリング**: API の一貫性確保

**受入条件**:

- メッセージアクセスが testId で分離される
- 他のテストへの影響がない
- 既存APIとの互換性を保つ

### Task 4.5: 検索機能の実装

**目的**: testId 分離された検索機能を実装する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: findMessages のテスト
   - testId 内での検索確認
   - 他のtestId への影響確認

2. **最小実装**: findMessages メソッド
3. **テスト作成**: hasMessage のテスト
4. **実装**: hasMessage メソッド
5. **リファクタリング**: 検索機能の最適化

**受入条件**:

- 検索が testId 内に限定される
- 文字列・正規表現での検索が動作する
- パフォーマンスが適切である

### Task 4.6: テスト管理機能の実装

**目的**: testId 管理と静的メソッド群を実装する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: getTestId のテスト
   - 設定されたtestId の正確な返却確認

2. **最小実装**: getTestId メソッド
3. **テスト作成**: 静的メソッドのテスト
   - getAllActiveTestIds の確認
   - getActiveTestCount の確認

4. **実装**: 静的メソッド群
5. **テスト作成**: cleanupAll のテスト
   - 全テストバッファの削除確認

6. **実装**: cleanupAll メソッド
7. **リファクタリング**: 静的管理の最適化

**受入条件**:

- testId 管理が正常に動作する
- 静的メソッドが適切に実装される
- 全体のクリーンアップが可能である

### Task 4.7: 個別クリーンアップ機能の実装

**目的**: 個別testId のクリーンアップ機能を実装する

**ファイル**: `plugins/logger/E2eMockLogger.ts`

**詳細タスク**:

1. **テスト作成**: cleanup のテスト
   - 該当testId のバッファ削除確認
   - 他のtestId への影響がないことの確認
   - cleanup後のgetBufferManager エラー確認

2. **最小実装**: cleanup メソッド
3. **テスト作成**: cleanup後の動作テスト
   - メソッド呼び出し時の適切なエラー確認

4. **テスト作成**: メモリリーク防止テスト
5. **リファクタリング**: リソース管理の最適化

**受入条件**:

- 個別testId のクリーンアップが動作する
- メモリリークが発生しない
- cleanup後の適切なエラーハンドリング

## Phase 5: 統合テストと互換性確認

### Task 5.1: MockLogger統合テストの実装

**目的**: MockLogger の統合動作を確認する

**詳細タスク**:

1. **テスト作成**: 既存APIとの完全互換性テスト
2. **テスト作成**: パフォーマンス回帰テスト
3. **テスト作成**: エラーハンドリング統合テスト
4. **不具合修正**: 発見された問題の修正
5. **リファクタリング**: 全体的な最適化

### Task 5.2: E2eMockLogger統合テストの実装

**目的**: E2eMockLogger の並列実行と分離性を確認する

**詳細タスク**:

1. **テスト作成**: 並列テスト実行での分離性テスト
2. **テスト作成**: メモリリーク防止テスト
3. **テスト作成**: 大量testId での性能テスト
4. **不具合修正**: 発見された問題の修正
5. **リファクタリング**: 性能とメモリ効率の最適化

### Task 5.3: 既存テストとの互換性確認

**目的**: 既存のテストコードとの互換性を保証する

**詳細タスク**:

1. **テスト実行**: 既存ユニットテストの実行確認
2. **テスト実行**: 既存統合テストの実行確認
3. **不具合修正**: 互換性問題の修正
4. **ドキュメント更新**: 変更点の文書化

## 実装完了条件

### 受入テスト

- 全ユニットテストが成功する
- 全統合テストが成功する
- 既存テストが全て成功する
- メモリリークが発生しない

### 品質確認

- 型チェック（`pnpm run check:types`）が成功する
- リンター（`pnpm run lint-all:types`）が成功する
- スペルチェック（`pnpm run check:spells`）が成功する
- フォーマットチェック（`pnpm run check:dprint`）が成功する

### パフォーマンス確認

- 現行実装と同等以上のパフォーマンスを維持する
- メモリ使用量が適切な範囲に収まる
- バッファオーバーフロー検出が正常に動作する

## 注意事項

### t-wada式TDD の厳守

- 各タスクで必ず失敗するテストから開始する
- 最小限の実装で Red から Green にする
- Green 達成後に必ずリファクタリングを行う
- 1つのタスクを完全に完成させてから次に進む

### BDD によるテスト記述

- `describe` と `it` を使用したテスト構造にする
- テストの意図が明確になるような記述にする
- 正常系・異常系の両方を適切にカバーする

### エラーハンドリング

- 全てのエラーで適切なエラークラスを使用する
- エラーメッセージ定数を必ず使用する
- context 情報を充実させてデバッグを容易にする
