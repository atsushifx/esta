---
header:
  - src: docs/.ccKiro/@esta-core/esta-config/esta-config.tasks.md
  - "@(#)": ESTA unified user configuration implementation tasks
title: ESTA統合ユーザー設定管理タスクドキュメント（@esta-core/esta-config）
description: ESTAツール群のユーザー設定を統合管理するパッケージの実装タスク
version: 1.0.0
created: 2025-07-20
updated: 2025-07-20
authors:
  - 🤖 Claude（タスク設計・実装方針）
  - 👤 atsushifx（タスク確認・承認）
changes:
  - 2025-07-20: 初回作成（詳細設計書に基づくタスク策定）
copyright:
  - Copyright (c) 2025 atsushifx <https://github.com/atsushifx>
  - This software is released under the MIT License.
  - https://opensource.org/licenses/MIT
---

## ESTA統合ユーザー設定管理 実装タスクドキュメント

### 1. 開発方針

#### 1.1 開発手法

t-wada式TDD（テスト駆動開発）に基づいて開発します。

1. テストリストの作成
2. 失敗するテストの作成（Red）
3. 最小限の実装（Green）
4. リファクタリング
5. 繰り返し

#### 1.2 開発順序

以下の順序で段階的に開発します。

1. プロジェクト基盤整備
2. 型定義とスキーマ定義
3. デフォルト設定機能
4. 設定ファイル読み込み機能
5. 設定マージ機能
6. 設定検証機能
7. メイン関数実装
8. 統合テスト

### 2. TDD開発タスクリスト

#### 2.1 プロジェクト基盤整備タスク

##### T001: パッケージ初期化

目的: パッケージの基本構造を作成

テストケース:

- package.jsonが正しい設定で生成される
- tsconfig.jsonが適切に設定される
- ディレクトリ構造が仕様通りに作成される

実装内容:

- パッケージディレクトリ作成
- package.json作成（依存関係含む）
- tsconfig.json設定
- 基本ディレクトリ構造作成

受入条件:

- `pnpm run build`が成功する
- TypeScript型チェックが通る

##### T002: 依存関係セットアップ

目的: 必要な外部依存関係を正しく設定

テストケース:

- 必要な依存関係がインストールされる
- workspace:*プロトコルが正しく設定される

実装内容:

- valibot の依存関係追加
- @esta-utils/config-loader の依存関係追加
- @agla-utils/ag-logger の依存関係追加

受入条件:

- 全ての依存関係が解決される
- ビルドエラーが発生しない

#### 2.2 型定義・スキーマ定義タスク

##### T003: 基本型定義

目的: EstaConfigとPartialEstaConfig型を定義

テストケース:

- EstaConfig型が要件通りのフィールドを持つ
- PartialEstaConfig型が正しくオプショナル型になる
- AgLogLevel型との互換性がある

実装内容:

- src/types/estaConfig.types.ts作成
- EstaConfig型定義
- PartialEstaConfig型定義
- 型エクスポート

受入条件:

- TypeScript型チェックが通る
- 型定義が仕様書と一致する

##### T004: エラー型定義

目的: カスタムエラークラスを定義

テストケース:

- ConfigNotFoundErrorが適切なメッセージを持つ
- ConfigParseErrorが元エラーを保持する
- ConfigValidationErrorが検証エラーを表現する

実装内容:

- ConfigNotFoundError クラス定義
- ConfigParseError クラス定義
- ConfigValidationError クラス定義

受入条件:

- 各エラークラスが正しく継承される
- エラーメッセージが適切に設定される

##### T005: valibotスキーマ定義

目的: 設定値検証用のスキーマを定義

テストケース:

- EstaConfigSchemaが全フィールドを検証する
- PartialEstaConfigSchemaがオプショナル検証を行う
- ログレベル範囲チェックが正しく動作する
- 不正値が適切にエラーになる

実装内容:

- src/schemas/estaConfig.schemas.ts作成
- EstaConfigSchema定義
- PartialEstaConfigSchema定義
- ログレベル検証関数

受入条件:

- 有効な設定値が検証を通る
- 無効な設定値がエラーになる

#### 2.3 デフォルト設定タスク

##### T006: デフォルト設定関数

目的: デフォルト設定を提供する関数を実装

テストケース:

- defaultEstaConfig()が要件通りの値を返す
- 返り値がEstaConfig型に適合する
- 定数エクスポートが同じ値を持つ

実装内容:

- src/defaults.ts作成
- defaultEstaConfig関数実装
- DEFAULT_ESTA_CONFIG定数定義

受入条件:

- デフォルト値が仕様書と一致する
- 関数呼び出しが成功する

#### 2.4 設定ファイル読み込みタスク

##### T007: 基本ファイル読み込み

目的: 指定されたパスから設定ファイルを読み込む

テストケース:

- 存在するファイルが正しく読み込まれる
- 存在しないファイルがnullを返す
- パースエラーが適切にハンドリングされる

実装内容:

- src/core/config/loadEstaConfig.ts作成
- loadEstaConfig関数実装
- エラーハンドリング実装

受入条件:

- 有効な設定ファイルが読み込める
- ファイル未存在時にnullが返る

##### T008: 設定ファイル検索

目的: 複数の設定ファイル名から自動検索する

テストケース:

- 優先順位に従って設定ファイルが検索される
- 最初に見つかったファイルが使用される
- 全て見つからない場合にnullが返る

実装内容:

- searchAndLoadConfig関数実装
- ファイル優先順位制御
- 複数ファイル対応

受入条件:

- .estarcが最優先で読み込まれる
- esta.config.*の優先順位が正しい

##### T009: 複数形式対応

目的: JSON、YAML、JS、TS形式の設定ファイルに対応

テストケース:

- .estarcファイル（JSON）が読み込める
- esta.config.jsonが読み込める
- esta.config.ymlが読み込める
- esta.config.jsが読み込める
- esta.config.tsが読み込める

実装内容:

- 各ファイル形式の読み込み対応
- @esta-utils/config-loaderとの連携
- 拡張子判定ロジック

受入条件:

- 全ての対応形式が正しく読み込める
- パース処理が正常動作する

#### 2.5 設定マージタスク

##### T010: 基本マージ機能

目的: デフォルト設定とユーザー設定をマージする

テストケース:

- ユーザー設定がnullの場合はデフォルト設定を返す
- ユーザー設定の値がデフォルト値を上書きする
- 部分的な設定が正しくマージされる

実装内容:

- src/core/config/mergeEstaConfig.ts作成
- mergeEstaConfig関数実装
- nullチェック処理

受入条件:

- マージ処理が仕様通りに動作する
- 型安全性が保たれる

##### T011: フィールド別マージ

目的: 各設定フィールドが正しくマージされる

テストケース:

- toolsConfigPathの上書きが正しく動作する
- logLevelの上書きが正しく動作する
- 一部フィールドのみの設定が正しく処理される

実装内容:

- フィールド毎のマージロジック
- undefined値の適切な処理
- 型チェック強化

受入条件:

- 各フィールドが独立してマージされる
- undefined値が正しく処理される

#### 2.6 設定検証タスク

##### T012: 基本検証機能

目的: マージされた設定をvalibotで検証する

テストケース:

- 有効な設定が検証を通る
- 無効な設定でエラーが発生する
- エラーメッセージが分かりやすい日本語になる

実装内容:

- src/core/config/validateEstaConfig.ts作成
- validateEstaConfig関数実装
- エラーメッセージ整形

受入条件:

- 検証が正しく動作する
- エラーメッセージが日本語化される

##### T013: ログレベル検証

目的: ログレベル値の範囲チェックを実装

テストケース:

- 0-6の値が有効として通る
- -1や7以上の値がエラーになる
- 非整数値がエラーになる
- 非数値がエラーになる

実装内容:

- ログレベル範囲チェック強化
- 整数チェック追加
- 詳細なエラーメッセージ

受入条件:

- ログレベル検証が厳密に動作する
- 不正値で適切なエラーが発生する

##### T014: パス検証

目的: toolsConfigPathの妥当性チェック

テストケース:

- 空文字列がエラーになる
- 有効なパス文字列が通る
- 非文字列値がエラーになる

実装内容:

- パス文字列の基本チェック
- 空文字列の拒否
- 型チェック強化

受入条件:

- パス検証が正しく動作する
- 不正なパスでエラーが発生する

#### 2.7 メイン関数実装タスク

##### T015: getEstaConfig基本実装

目的: メインAPIとなるgetEstaConfig関数を実装

テストケース:

- configPathを指定した場合に正しく動作する
- configPathを省略した場合に自動検索が動作する
- 設定ファイルが見つからない場合にデフォルト設定を返す

実装内容:

- src/getEstaConfig.ts作成
- メイン処理フロー実装
- 各機能の統合

受入条件:

- API仕様通りに動作する
- エラーハンドリングが適切

##### T016: 設定ファイル自動検索

目的: configPath未指定時の自動検索機能

テストケース:

- 設定ファイルの優先順位が正しい
- 複数ファイルが存在する場合に優先度の高いものが選ばれる
- 全て見つからない場合にデフォルト設定が使用される

実装内容:

- searchAndLoadConfig関数統合
- ファイル検索ロジック
- フォールバック処理

受入条件:

- 自動検索が仕様通りに動作する
- フォールバック処理が正しい

##### T017: エラーハンドリング統合

目的: 全体のエラーハンドリングを統合

テストケース:

- ファイル読み込みエラーが適切に処理される
- パースエラーが適切に伝播される
- 検証エラーが適切に伝播される

実装内容:

- 統合エラーハンドリング
- エラー種別の適切な処理
- スタックトレース保持

受入条件:

- 全てのエラーが適切に処理される
- エラー情報が十分に提供される

#### 2.8 パッケージエクスポートタスク

##### T018: メインエクスポート

目的: パッケージの公開APIを定義

テストケース:

- 必要な関数がエクスポートされる
- 型定義がエクスポートされる
- エラークラスがエクスポートされる

実装内容:

- src/index.ts作成
- 公開API定義
- 型エクスポート設定

受入条件:

- 必要なAPIが全てエクスポートされる
- TypeScript型情報が正しく提供される

##### T019: 内部関数エクスポート

目的: テストやデバッグ用の内部関数エクスポート

テストケース:

- 内部関数が必要に応じてエクスポートされる
- 公開APIと内部APIが区別される

実装内容:

- 内部関数の選択的エクスポート
- APIドキュメント整備

受入条件:

- 必要な内部関数がアクセス可能
- API境界が明確

#### 2.9 統合テストタスク

##### T020: E2E設定ファイルテスト

目的: 実際の設定ファイルでのE2Eテスト

テストケース:

- 各設定ファイル形式での動作確認
- 設定値の正しい読み込みと適用
- 複数ファイル存在時の優先順位

実装内容:

- tests/e2e/configFileFormats.spec.ts作成
- 実ファイルでのテスト
- フィクスチャファイル作成

受入条件:

- 全ての対応形式でE2Eテストが通る
- 設定値が正しく適用される

##### T021: 設定検索E2Eテスト

目的: 設定ファイル自動検索のE2Eテスト

テストケース:

- 複数設定ファイル存在時の優先順位
- 設定ファイル未存在時のデフォルト使用
- 異常な設定ファイルでのエラーハンドリング

実装内容:

- tests/e2e/configFileSearch.spec.ts作成
- 複数ファイルパターンテスト
- エラーケーステスト

受入条件:

- 検索ロジックが正しく動作する
- エラーハンドリングが適切

##### T022: 設定検証E2Eテスト

目的: 設定値検証のE2Eテスト

テストケース:

- 有効な設定値での正常動作
- 無効な設定値でのエラー発生
- エラーメッセージの妥当性

実装内容:

- tests/e2e/configValidation.spec.ts作成
- 不正設定ファイルでのテスト
- エラーメッセージ確認

受入条件:

- 検証ロジックが正しく動作する
- エラーメッセージが分かりやすい

#### 2.10 品質保証タスク

##### T023: ユニットテストカバレッジ

目的: 90%以上のテストカバレッジを達成

テストケース:

- 全ての公開関数がテストされる
- 主要なエラーパスがテストされる
- エッジケースがカバーされる

実装内容:

- 不足テストケースの追加
- カバレッジレポート確認
- テスト品質向上

受入条件:

- ユニットテストカバレッジ90%以上
- 重要な機能が全てテストされる

##### T024: 型チェック・リント

目的: TypeScript型チェックとESLintの通過

テストケース:

- TypeScript型チェックが通る
- ESLintルールが通る
- コード品質基準を満たす

実装内容:

- 型エラーの修正
- リントエラーの修正
- コード品質向上

受入条件:

- `pnpm run check:types`が成功
- `pnpm run lint`が成功

##### T025: ビルド・パッケージング

目的: 正しいビルド出力とパッケージング

テストケース:

- CJS/ESM両形式でビルドされる
- 型定義ファイルが生成される
- パッケージが正しくエクスポートされる

実装内容:

- tsup設定調整
- package.json exports設定
- ビルド出力確認

受入条件:

- `pnpm run build`が成功
- 出力ファイルが正しく生成される

### 3. 開発環境設定

#### 3.1 必要ツール

- Node.js 20.x以上
- pnpm（パッケージマネージャー）
- TypeScript 5.0以上
- Vitest（テストランナー）

#### 3.2 開発コマンド

```bash
# パッケージの作成
pnpm create @esta-core/esta-config

# 依存関係インストール
pnpm install

# 開発ビルド
pnpm run build

# ユニットテスト実行
pnpm run test:develop

# E2Eテスト実行
pnpm run test:ci

# 型チェック
pnpm run check:types

# リント
pnpm run lint

# 全品質チェック
pnpm run lint-all && pnpm run lint-all:types && pnpm run check:types
```

### 4. 実装順序とマイルストーン

#### 4.1 マイルストーン1: 基盤整備（T001-T006）

- プロジェクト初期化
- 型定義とスキーマ
- デフォルト設定

完了条件: 基本的な型とデフォルト設定が動作する

#### 4.2 マイルストーン2: 設定処理（T007-T014）

- ファイル読み込み
- 設定マージ
- 設定検証

完了条件: 設定ファイルの読み込みと検証が動作する

#### 4.3 マイルストーン3: API統合（T015-T019）

- メイン関数実装
- パッケージエクスポート

完了条件: 公開APIが仕様通りに動作する

#### 4.4 マイルストーン4: 品質保証（T020-T025）

- E2Eテスト
- 品質チェック
- リリース準備

完了条件: 全てのテストが通り、品質基準を満たす

### 5. 受入基準

#### 5.1 機能要件

- `.estarc`および`esta.config.*`からの設定読み込み
- デフォルト設定とのマージ
- valibot による設定検証
- ログレベル値の範囲チェック（0-6）

#### 5.2 品質要件

- ユニットテストカバレッジ90%以上
- TypeScript型チェック通過
- ESLintルール通過
- 設定読み込み時間50ms以内

#### 5.3 互換性要件

- 既存パッケージとの循環依存なし
- @esta-utils/config-loaderとの連携
- @agla-utils/ag-loggerとの型互換性

### 6. リスク対応

#### 6.1 技術リスク

- valibotのバージョン互換性: 最新安定版を使用し、破壊的変更に注意
- config-loaderとの連携: インターフェース仕様を事前確認
- 循環依存: 依存関係グラフを定期的にチェック

#### 6.2 品質リスク

- テストカバレッジ不足: 開発初期からテストファーストで実装
- 型安全性: strictモードでの開発と型チェック
- パフォーマンス: ベンチマークテストの実装

### 7. 完了チェックリスト

#### 7.1 実装チェック

- [ ] 全タスク（T001-T025）が完了
- [ ] 公開API仕様との一致確認
- [ ] 内部設計仕様との一致確認

#### 7.2 テストチェック

- [ ] ユニットテスト90%以上カバレッジ
- [ ] E2Eテスト全パターン実行
- [ ] エラーハンドリングテスト完了

#### 7.3 品質チェック

- [ ] TypeScript型チェック通過
- [ ] ESLintルール通過
- [ ] パフォーマンス要件達成
- [ ] セキュリティチェック完了

#### 7.4 統合チェック

- [ ] 他パッケージとの統合テスト
- [ ] 循環依存チェック
- [ ] ビルド出力検証
