---
title: MockLogger リファクタリング計画書（責務分離と構造整理）
version: 1.2.0
created: 2025-07-25
updated: 2025-07-25
authors:
- 👤 atsushifx（技術方針と意思決定）
  - 🩶 Elpha （仕様構成・機械的設計支援）
  - 🔸 小紅（テスト観点からの提案）
  - 🔸 つむぎ（API整備と開発者体験の整理）
---

# 📋 MockLogger リファクタリング計画書

## 🎯 目的

本ドキュメントは、`@agla-utils/ag-logger` における `MockLogger` および `E2eMockLogger` の内部構造を見直し、以下の目的を達成するためのリファクタリング計画を示す：

- 単一責務の原則（SRP）に基づく構造整理
- テスト容易性・拡張性・保守性の向上
- Logger API に特化した明確なクラス設計
- 内部構造の関数型パラダイム移行
- 並列テスト時のメモリ管理改善

---

## 🧩 現状の課題と背景

### MockLogger の課題

- ログ出力APIとメッセージ記録・検証処理が単一クラスに集約されており、構造が肥大化
- バッファ管理ロジックが分散し、再利用性やテスト性が損なわれている

### E2eMockLogger の課題

- `testId` ごとのログ分離のために `Map<testId, level -> message[]>` を保持し、構造が複雑
- `startTest()` / `endTest()` による状態管理が必須で、明示的な testId 指定も煩雑
- バッファの自動破棄が行われず、メモリリークの可能性がある

---

## 🔧 設計方針と変更点

### MockLogger リファクタリング方針

- MockLogger はファクトリーメソッドを廃止し、通常のクラスインスタンス化のみを許容
- ログ出力 API（info, warn, error 等）を提供する純粋なロガーインターフェースとして整理
- ログ記録・検索などの内部処理は LogBufferManager に委譲
- 外部からの使用感は従来と変えず、構造だけを純化する

### LogBufferManager の導入

- ログレベルごとのバッファ保持と制御を担当
- 最大バッファサイズ・循環バッファの制御
- メッセージの検索、クリア、部分削除などのユーティリティを提供
- `cleanup()` メソッドによりバッファを明示的に破棄可能

---

## 🧭 E2eMockLogger 再設計方針（LogBufferManager連携）

### 目的

- 複雑な多重構造を排除し、各 testId に対して LogBufferManager を割り当てる単純な設計へ移行
- E2eMockLogger 自体は API とバッファ割り当てハンドラに徹する
- testId をコンストラクタで渡し、内部に保持することで API における明示的な testId 引数を不要にする

### 新構造の概要

- E2eMockLogger は testId を1つだけ保持し、すべてのログ操作とクエリにその ID を使用
- バッファは Map<testId, LogBufferManager> によって内部管理される
- メモリリーク防止のため、cleanup() を導入して afterEach で明示的に破棄する運用を推奨

### 設計判断と理由

- testId をコンストラクタで渡すことで、使用者が API 呼び出しごとに ID を指定する必要がなくなる
- バッファ破棄の責任は呼び出し元が明示的に `logger.cleanup()` を呼ぶことで制御
- 従来の startTest / endTest は不要となり、内部的にバッファは自動で生成・登録される
- createTestId 関数により一貫した ID 生成が行われているため、ID衝突や重複の懸念はない

### 使用パターンの推奨

- beforeEach: ロガーの初期化
- afterEach: logger.cleanup() によるバッファ破棄

### 効果と展望

- メモリリークの回避：logger ごとに明示的にクリーンアップ可能
- テストごとのスコープ分離が直感的に扱える構造となる
- startTest / endTest のような状態遷移を排除し、構造の予測可能性が向上

---

## 🧪 テスト戦略

- MockLogger: ユーザー視点での統合テストを中心に記述
- LogBufferManager: 記録、検索、削除、バッファ制限に関するユニットテストを記述
- E2eMockLogger: 複数 testId における隔離性と破棄処理の正当性を検証

---

## 📅 実装フェーズ案

| フェーズ | 内容                               | 目安期間 |
| -------- | ---------------------------------- | -------- |
| Phase 1  | LogBufferManager の新設・責務移行  | 1日      |
| Phase 2  | MockLogger の委譲構造化            | 1日      |
| Phase 3  | E2eMockLogger の再構築とテスト整理 | 1日      |

---

## 📈 期待される効果

- 役割分離による保守性と拡張性の向上
- テストログの構造とスコープの明確化
- ピュア関数型構造によるテスト容易性の向上
- バッファ破棄責任の明示化によるメモリ安全性の確保

---

## 📌 備考：設計原則の継続

- ag-logger 全体は「外部 API はクラスベース、内部構造は関数型」というハイブリッド設計方針を維持
- 今回のリファクタリングはこの原則を踏襲し、テスト向けロガーの構造的健全性を高めることを目的とする
- 実装は「t-wada式BDD」ですすめる。すなわち、実装を細かいタスクリストまで分解し、
  一つのタスクごとに完成まで実装する形で、順番に実装する
